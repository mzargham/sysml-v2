## SysML v2 API Server â€” Local Development Stack
##
## Services:
##   - PostgreSQL 15 (port 5432)
##   - SysML v2 API server (port 9000)
##
## The API server is built from the official Systems-Modeling source
## (no pre-built Docker image exists).
##
## First run will take a few minutes to compile.
##
## Usage:
##   docker compose -f docker/docker-compose.yml up -d --build
##   docker compose -f docker/docker-compose.yml down

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: sysml2
      POSTGRES_PASSWORD: sysml2
      POSTGRES_DB: sysml2
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sysml2"]
      interval: 5s
      timeout: 5s
      retries: 5

  api-server:
    build:
      context: .
      dockerfile_inline: |
        FROM eclipse-temurin:17-jdk AS builder
        RUN apt-get update && apt-get install -y git
        WORKDIR /build
        RUN git clone --depth 1 https://github.com/Systems-Modeling/SysML-v2-API-Services.git .
        RUN chmod +x gradlew && ./gradlew installDist

        FROM eclipse-temurin:17-jre
        COPY --from=builder /build/app/build/install/SysML-v2-API-Services /app
        WORKDIR /app
        EXPOSE 9000
        CMD ["bin/SysML-v2-API-Services", \
             "-Dconfig.file=conf/application.conf", \
             "-Dplay.evolutions.db.default.autoApply=true", \
             "-Dslick.dbs.default.db.url=jdbc:postgresql://postgres:5432/sysml2", \
             "-Dslick.dbs.default.db.user=sysml2", \
             "-Dslick.dbs.default.db.password=sysml2"]
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "9000:9000"

volumes:
  pgdata:
